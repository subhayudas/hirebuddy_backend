# Email Log API Documentation

This document describes the new email log endpoints that interact with the `useremaillog` table to provide email tracking and analytics functionality.

## Table Schema

The `useremaillog` table has the following structure:

```sql
create table public.useremaillog (
  id bigint generated by default as identity not null,
  sent_at timestamp with time zone not null default now(),
  "to" character varying null,
  user_id character varying null,
  "messageId" character varying null,
  "threadId" character varying null,
  reference character varying null,
  subject character varying null,
  constraint useremaillog_pkey primary key (id)
);
```

## Authentication

All endpoints require authentication via JWT token in the Authorization header:
```
Authorization: Bearer <jwt-token>
```

## Endpoints

### 1. GET /api/email/stats

Get email statistics including total sent, monthly counts, and current/last month comparisons.

**Response:**
```json
{
  "success": true,
  "data": {
    "totalSent": 150,
    "monthlyCounts": {
      "2024-01": 25,
      "2024-02": 30,
      "2024-03": 35
    },
    "thisMonth": 35,
    "lastMonth": 30
  },
  "message": "Email statistics retrieved successfully"
}
```

### 2. GET /api/email/contacts-with-emails

Get a list of contacts who have received emails, with their email count and last email details.

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "email": "contact@example.com",
      "lastEmailSent": "2024-03-15T10:30:00Z",
      "emailCount": 3,
      "lastSubject": "Follow-up on our conversation"
    }
  ],
  "message": "Contacts with emails retrieved successfully"
}
```

### 3. GET /api/email/conversation-history/{contactId}

Get the complete conversation history for a specific contact.

**Parameters:**
- `contactId` (path parameter): Email address of the contact

**Response:**
```json
{
  "success": true,
  "data": {
    "logs": [
      {
        "id": 1,
        "sent_at": "2024-03-10T09:00:00Z",
        "to": "contact@example.com",
        "user_id": "user@example.com",
        "messageId": "msg_123",
        "threadId": "thread_456",
        "reference": "ref_789",
        "subject": "Initial outreach"
      }
    ],
    "totalEmails": 3,
    "firstEmailDate": "2024-03-10T09:00:00Z",
    "lastEmailDate": "2024-03-15T10:30:00Z"
  },
  "message": "Conversation history retrieved successfully"
}
```

### 4. GET /api/email/conversation-stats/{contactId}

Get conversation statistics for a specific contact including engagement metrics.

**Parameters:**
- `contactId` (path parameter): Email address of the contact

**Response:**
```json
{
  "success": true,
  "data": {
    "totalEmails": 3,
    "firstEmailDate": "2024-03-10T09:00:00Z",
    "lastEmailDate": "2024-03-15T10:30:00Z",
    "averageEmailsPerDay": 0.6,
    "daysSinceLastEmail": 5
  },
  "message": "Conversation statistics retrieved successfully"
}
```

### 5. POST /api/email/log

Log a new email to the useremaillog table.

**Request Body:**
```json
{
  "to": "recipient@example.com",
  "messageId": "msg_123",
  "threadId": "thread_456",
  "reference": "ref_789",
  "subject": "Email subject"
}
```

**Required Fields:**
- `to`: Recipient email address
- `messageId`: Unique message identifier

**Optional Fields:**
- `threadId`: Thread identifier for conversation grouping
- `reference`: Reference identifier
- `subject`: Email subject line

**Response:**
```json
{
  "success": true,
  "data": {
    "id": 123,
    "sent_at": "2024-03-20T14:30:00Z",
    "to": "recipient@example.com",
    "user_id": "user@example.com",
    "messageId": "msg_123",
    "threadId": "thread_456",
    "reference": "ref_789",
    "subject": "Email subject"
  },
  "message": "Email logged successfully"
}
```

### 6. GET /api/email/followups-needed

Get contacts who need follow-up emails (emails sent more than 7 days ago).

**Response:**
```json
{
  "success": true,
  "data": [
    {
      "email": "contact@example.com",
      "lastEmailSent": "2024-03-10T09:00:00Z",
      "daysSinceLastEmail": 10,
      "emailCount": 2,
      "lastSubject": "Initial outreach"
    }
  ],
  "message": "Follow-up contacts retrieved successfully"
}
```

## Error Responses

All endpoints return consistent error responses:

**400 Bad Request:**
```json
{
  "success": false,
  "error": "Contact ID is required"
}
```

**401 Unauthorized:**
```json
{
  "success": false,
  "error": "Authentication required"
}
```

**422 Validation Error:**
```json
{
  "success": false,
  "error": "Validation failed: Invalid email format"
}
```

**500 Internal Server Error:**
```json
{
  "success": false,
  "error": "Internal server error"
}
```

## Usage Examples

### Frontend Integration

```javascript
// Get email statistics
const stats = await fetch('/api/email/stats', {
  headers: { 'Authorization': `Bearer ${token}` }
});

// Log a new email
const logEmail = await fetch('/api/email/log', {
  method: 'POST',
  headers: { 
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    to: 'recipient@example.com',
    messageId: 'msg_123',
    subject: 'Follow-up email'
  })
});

// Get conversation history
const history = await fetch('/api/email/conversation-history/recipient@example.com', {
  headers: { 'Authorization': `Bearer ${token}` }
});
```

### Database Queries

The endpoints use the following Supabase queries:

1. **Total emails count:**
```sql
SELECT COUNT(*) FROM useremaillog WHERE user_id = $1
```

2. **Monthly emails:**
```sql
SELECT COUNT(*) FROM useremaillog 
WHERE user_id = $1 AND sent_at >= $2
```

3. **Contacts with emails:**
```sql
SELECT to, sent_at, subject FROM useremaillog 
WHERE user_id = $1 AND to IS NOT NULL 
ORDER BY sent_at DESC
```

4. **Conversation history:**
```sql
SELECT * FROM useremaillog 
WHERE user_id = $1 AND to = $2 
ORDER BY sent_at ASC
```

## Notes

- All timestamps are in ISO 8601 format with timezone information
- Email addresses are used as contact identifiers
- The follow-up threshold is set to 7 days but can be easily modified
- Monthly statistics are calculated for the last 12 months
- All endpoints include proper CORS handling for frontend integration



